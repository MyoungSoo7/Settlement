apiVersion: apps/v1
kind: Deployment
metadata:
  name: lemuel-app
  namespace: lemuel
  labels:
    app: lemuel
    tier: backend
spec:
  replicas: 3  # High Availability: 3개의 Pod 실행
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # 업데이트 시 최대 1개 추가 Pod 생성 가능
      maxUnavailable: 1  # 업데이트 시 최대 1개 Pod 중단 가능
  selector:
    matchLabels:
      app: lemuel
      tier: backend
  template:
    metadata:
      labels:
        app: lemuel
        tier: backend
    spec:
      # Pod Anti-Affinity: 같은 노드에 배포되지 않도록 (단일 노드에서는 무시됨)
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - lemuel
                topologyKey: kubernetes.io/hostname

      # Graceful Shutdown을 위한 종료 유예 시간
      terminationGracePeriodSeconds: 60

      containers:
        - name: lemuel
          image: ghcr.io/your-org/lemuel:latest  # GitHub Actions에서 빌드된 이미지
          imagePullPolicy: Always

          ports:
            - name: http
              containerPort: 8080
              protocol: TCP

          # Environment Variables from ConfigMap
          envFrom:
            - configMapRef:
                name: lemuel-config
            - secretRef:
                name: lemuel-secret

          # Additional Environment Variables
          env:
            - name: SPRING_DATASOURCE_URL
              value: "jdbc:postgresql://$(POSTGRES_HOST):$(POSTGRES_PORT)/$(POSTGRES_DB)"
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: lemuel-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: lemuel-secret
                  key: POSTGRES_PASSWORD

          # Resource Limits and Requests
          resources:
            requests:
              memory: "512Mi"   # 최소 메모리
              cpu: "250m"       # 최소 CPU (0.25 core)
            limits:
              memory: "2Gi"     # 최대 메모리
              cpu: "1000m"      # 최대 CPU (1 core)

          # Liveness Probe: 컨테이너가 살아있는지 확인
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8080
            initialDelaySeconds: 90   # 시작 후 90초 대기
            periodSeconds: 10         # 10초마다 체크
            timeoutSeconds: 5         # 5초 타임아웃
            failureThreshold: 3       # 3번 실패 시 재시작

          # Readiness Probe: 트래픽을 받을 준비가 되었는지 확인
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8080
            initialDelaySeconds: 60   # 시작 후 60초 대기
            periodSeconds: 5          # 5초마다 체크
            timeoutSeconds: 3         # 3초 타임아웃
            failureThreshold: 3       # 3번 실패 시 트래픽 차단

          # Startup Probe: 초기 시작 시간이 오래 걸리는 경우
          startupProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8080
            initialDelaySeconds: 0
            periodSeconds: 10
            failureThreshold: 30      # 최대 300초(5분) 대기

          # Volume Mounts (필요한 경우)
          volumeMounts:
            - name: logs
              mountPath: /app/logs

      volumes:
        - name: logs
          emptyDir: {}

      # Image Pull Secrets (Private Registry 사용 시)
      # imagePullSecrets:
      #   - name: ghcr-secret
