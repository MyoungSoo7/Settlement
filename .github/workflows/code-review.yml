name: Automated Code Review

on:
  pull_request:
    branches: [ main, master ]
    types: [ opened, synchronize, reopened ]

concurrency:
  group: code-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  code-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Checkstyle
      - name: Run Checkstyle
        id: checkstyle
        run: ./gradlew checkstyleMain checkstyleTest --no-daemon
        continue-on-error: true

      - name: Upload Checkstyle Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: build/reports/checkstyle/
          retention-days: 7

      # Reviewdog (parse checkstyle xml -> PR review comments)
      - name: Reviewdog (Checkstyle)
        if: always()
        uses: reviewdog/action-reviewdog@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          level: warning
          filter_mode: diff_context
          fail_on_error: "false"
          tool_name: checkstyle
          run: |
            # main + test ë‘˜ ë‹¤ ìžˆìœ¼ë©´ ë‘˜ ë‹¤ ì˜¬ë¦¼. ì—†ìœ¼ë©´ ìžˆëŠ” ê²ƒë§Œ ì˜¬ë¦¼.
            if [ -f build/reports/checkstyle/main.xml ]; then
              reviewdog -f=checkstyle -name="checkstyle(main)" -reporter=github-pr-review -filter-mode=diff_context -fail-on-error=false -level=warning < build/reports/checkstyle/main.xml
            fi
            if [ -f build/reports/checkstyle/test.xml ]; then
              reviewdog -f=checkstyle -name="checkstyle(test)" -reporter=github-pr-review -filter-mode=diff_context -fail-on-error=false -level=warning < build/reports/checkstyle/test.xml
            fi

      # Dependency vulnerability check
      - name: Run Dependency Check
        id: depcheck
        run: ./gradlew dependencyCheckAnalyze --no-daemon || echo "Dependency check completed with warnings"
        continue-on-error: true

      # PR size + summary (ONE comment, update)
      - name: Post/Update Review Summary (single comment)
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            // PR stats
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: issue_number });
            const additions = pr.data.additions;
            const deletions = pr.data.deletions;
            const changedFiles = pr.data.changed_files;
            const total = additions + deletions;

            let sizeLabel = 'ðŸŸ¢ Small';
            let sizeMsg = 'Reasonable size.';
            if (total > 1000) { sizeLabel = 'ðŸ”´ Large'; sizeMsg = 'Consider splitting into smaller PRs.'; }
            else if (total > 500) { sizeLabel = 'ðŸŸ¡ Medium'; sizeMsg = 'Keep scope focused.'; }

            // Build a single body
            const marker = '<!-- AUTO_CODE_REVIEW_SUMMARY -->';
            const body =
              `${marker}\n` +
              `## ðŸ¤– Automated Code Review\n\n` +
              `### âœ… Checks\n` +
              `- Checkstyle: ${process.env.CHECKSTYLE_STATUS || 'done (see artifacts / review comments)'}\n` +
              `- Dependency Check: ${process.env.DEPCHECK_STATUS || 'done (see logs)'}\n\n` +
              `### ðŸ“ PR Size\n` +
              `**Size**: ${sizeLabel}\n` +
              `- Lines added: ${additions}\n` +
              `- Lines deleted: ${deletions}\n` +
              `- Files changed: ${changedFiles}\n` +
              `- Total changes: ${total}\n` +
              `> ${sizeMsg}\n\n` +
              `### ðŸ“¦ Reports\n` +
              `- Checkstyle report: workflow artifact (build/reports/checkstyle)\n` +
              `- Reviewdog comments: on PR diff\n\n` +
              `---\n` +
              `*Generated by GitHub Actions*\n`;

            // Find existing summary comment and update it
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const existing = comments.data.find(c => (c.body || '').includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
