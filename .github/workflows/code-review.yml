name: Automated Code Review

on:
  pull_request:
    branches: [ main, master ]
    types: [ opened, synchronize, reopened ]

jobs:
  code-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Checkstyle - Code style analysis
      - name: Run Checkstyle
        run: ./gradlew checkstyleMain checkstyleTest --no-daemon
        continue-on-error: true

      - name: Upload Checkstyle Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: build/reports/checkstyle/
          retention-days: 7

      - name: Checkstyle Report with Reviewdog
        if: always()
        uses: reviewdog/action-checkstyle@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          level: warning
          checkstyle_config: .github/checkstyle.xml
          fail_on_error: false

      # Dependency vulnerability check
      - name: Run Dependency Check
        run: |
          ./gradlew dependencyCheckAnalyze --no-daemon || echo "Dependency check completed with warnings"
        continue-on-error: true

      # Architecture validation
      - name: Check Hexagonal Architecture Violations
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            // Simple architecture rule checker
            const violations = [];

            // Check if domain entities are used in controllers
            const findFiles = (dir, pattern) => {
              const files = [];
              const items = fs.readdirSync(dir, { withFileTypes: true });
              for (const item of items) {
                const fullPath = path.join(dir, item.name);
                if (item.isDirectory() && !item.name.includes('node_modules') && !item.name.includes('.git')) {
                  files.push(...findFiles(fullPath, pattern));
                } else if (item.isFile() && pattern.test(item.name)) {
                  files.push(fullPath);
                }
              }
              return files;
            };

            // Check controller files
            try {
              const controllerFiles = findFiles('src/main/java', /Controller\.java$/);

              for (const file of controllerFiles) {
                const content = fs.readFileSync(file, 'utf8');

                // Check for direct domain entity usage in return types
                if (content.includes('return') && content.match(/domain\.\w+(?!Exception)/)) {
                  violations.push(`âš ï¸ ${file}: Possible domain entity exposure in controller`);
                }

                // Check for business logic in controllers
                if (content.match(/new\s+\w+Service\(/)) {
                  violations.push(`âš ï¸ ${file}: Direct service instantiation (should use DI)`);
                }
              }

              if (violations.length > 0) {
                const comment = `## ğŸ—ï¸ Architecture Review\n\n### âš ï¸ Potential Architecture Violations\n\n${violations.join('\n')}\n\n` +
                  `### ğŸ“‹ Hexagonal Architecture Checklist\n` +
                  `- Controllers should only use DTOs/Responses, not domain entities\n` +
                  `- Business logic should be in Domain/Application layer\n` +
                  `- Dependencies should point inward (Adapter â†’ Application â†’ Domain)\n` +
                  `- Use dependency injection, not direct instantiation\n\n` +
                  `> ğŸ’¡ **Note**: This is an automated check. Please review manually.`;

                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Architecture check completed');
            }

      # Test quality check
      - name: Check Test Coverage by Package
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## ğŸ§ª Test Quality Reminder\n\n` +
              `### Test Coverage Guidelines\n` +
              `- **Domain Layer**: Should have comprehensive unit tests\n` +
              `- **Application Layer**: Test use cases and service orchestration\n` +
              `- **Adapter Layer**: Test integration with external systems\n\n` +
              `### Best Practices\n` +
              `- âœ… Use meaningful test names (@DisplayName)\n` +
              `- âœ… Follow AAA pattern (Arrange-Act-Assert)\n` +
              `- âœ… Test edge cases and error scenarios\n` +
              `- âœ… Use @Nested for grouping related tests\n` +
              `- âœ… Mock external dependencies properly\n\n` +
              `> Check the detailed JaCoCo report in the CI pipeline`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # PR size check
      - name: Check PR Size
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const additions = pr.data.additions;
            const deletions = pr.data.deletions;
            const changedFiles = pr.data.changed_files;
            const total = additions + deletions;

            let sizeLabel = 'ğŸŸ¢ Small';
            let message = 'This is a reasonably sized PR. Good job!';

            if (total > 1000) {
              sizeLabel = 'ğŸ”´ Large';
              message = 'âš ï¸ This PR is quite large. Consider breaking it into smaller PRs for easier review.';
            } else if (total > 500) {
              sizeLabel = 'ğŸŸ¡ Medium';
              message = 'This PR is moderately sized. Ensure it focuses on a single concern.';
            }

            const comment = `## ğŸ“ PR Size Analysis\n\n` +
              `**Size**: ${sizeLabel}\n` +
              `- **Lines added**: ${additions}\n` +
              `- **Lines deleted**: ${deletions}\n` +
              `- **Files changed**: ${changedFiles}\n` +
              `- **Total changes**: ${total}\n\n` +
              `${message}\n\n` +
              `### ğŸ’¡ Tips for Large PRs\n` +
              `- Split into multiple smaller PRs by feature/layer\n` +
              `- Separate refactoring from feature changes\n` +
              `- Keep changes focused on a single concern`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # Summary comment
      - name: Post Review Summary
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## ğŸ¤– Automated Code Review Complete\n\n` +
              `### âœ… Checks Performed\n` +
              `- âœ… Checkstyle analysis\n` +
              `- âœ… Architecture validation\n` +
              `- âœ… Test quality guidelines\n` +
              `- âœ… PR size analysis\n` +
              `- âœ… Dependency vulnerability check\n\n` +
              `### ğŸ“Š Review Reports\n` +
              `Check the workflow artifacts for detailed reports.\n\n` +
              `### ğŸ‘€ Manual Review Required\n` +
              `Automated checks are helpful but not exhaustive. Please ensure:\n` +
              `- Business logic correctness\n` +
              `- Security considerations\n` +
              `- Performance implications\n` +
              `- API contract compatibility\n\n` +
              `---\n` +
              `*Generated by GitHub Actions - Automated Code Review*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
